<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <title>SV Gutachten Schwei√ütechnik v8.0 - Multi-Bild KI-Vision + ZfP</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <!-- DOCX Libraries mit defer f√ºr besseres Laden -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/docx/8.2.0/docx.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { 
      font-family: system-ui, -apple-system, sans-serif; 
      background: linear-gradient(135deg, #e0f2fe 0%, #f0f9ff 50%, #e0f2fe 100%); 
      min-height: 100vh;
      -webkit-text-size-adjust: 100%;
    }
    
    /* KRITISCH: Mobile Touch Fix - entfernt 300ms Delay */
    html {
      touch-action: manipulation;
    }
    
    /* Alle klickbaren Elemente mobile-optimiert */
    button, a, select, input, [role="button"] {
      touch-action: manipulation;
      -webkit-tap-highlight-color: rgba(0,0,0,0.1);
      cursor: pointer;
      user-select: none;
      -webkit-user-select: none;
    }
    
    /* Buttons brauchen minimum Touch-Target-Gr√∂√üe */
    button {
      min-height: 44px;
      min-width: 44px;
    }
    
    /* Links m√ºssen auch Touch-friendly sein */
    a {
      -webkit-touch-callout: none;
    }
    
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    @keyframes scan { 0% { top: 0; } 100% { top: calc(100% - 4px); } }
    .scanning { animation: pulse 1.5s ease-in-out infinite; }
    .scan-line { position: absolute; left: 0; right: 0; height: 4px; background: linear-gradient(90deg, transparent, #f97316, transparent); animation: scan 2s ease-in-out infinite; }
    .loading { display: inline-block; width: 20px; height: 20px; border: 2px solid #fff; border-top-color: transparent; border-radius: 50%; animation: spin 0.8s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    
    /* Mobile Responsive */
    .dashboard-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 24px; }
    .status-grid { display: flex; gap: 12px; }
    .analyse-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; }
    .katalog-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; }
    
    @media (max-width: 1024px) {
      .dashboard-grid { grid-template-columns: repeat(2, 1fr); }
      .analyse-grid { grid-template-columns: 1fr; }
      .katalog-grid { grid-template-columns: repeat(2, 1fr); }
    }
    
    @media (max-width: 768px) {
      .dashboard-grid { grid-template-columns: 1fr; }
      .status-grid { flex-direction: column; }
      .katalog-grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <div id="root"></div>
  
  <script>
    window.onerror = function(msg, url, lineNo, columnNo, error) {
      console.error('Error:', msg, 'at', url, lineNo, columnNo, error);
      return false;
    };
    window.onunhandledrejection = function(event) {
      console.error('Promise rejection:', event.reason);
    };
  </script>
  <script type="text/babel">
    const { useState, useEffect, useCallback, useRef } = React;

    // API Base URL
    const API_BASE = '';

    // Schwei√üfehler-Katalog nach ISO 5817
    const FEHLERKATALOG = {
      "100": { name: "Riss", gruppe: "1", beschreibung: "L√§ngsriss, Querriss, Kraterriss", kritisch: true },
      "2011": { name: "Pore", gruppe: "2", beschreibung: "Einzelne Gaspore", kritisch: false },
      "2012": { name: "Porosit√§t", gruppe: "2", beschreibung: "Verteilte Poren", kritisch: false },
      "2013": { name: "Porennest", gruppe: "2", beschreibung: "Lokale Porenansammlung", kritisch: false },
      "2014": { name: "Porenzeile", gruppe: "2", beschreibung: "Linear angeordnete Poren", kritisch: true },
      "2024": { name: "Endkraterlunker", gruppe: "2", beschreibung: "Lunker am Nahtende", kritisch: false },
      "3011": { name: "Schlackeneinschluss", gruppe: "3", beschreibung: "Eingeschlossene Schlacke", kritisch: false },
      "401": { name: "Bindefehler", gruppe: "4", beschreibung: "Unvollst√§ndige Bindung", kritisch: true },
      "4021": { name: "Wurzelfehler", gruppe: "4", beschreibung: "Unvollst√§ndige Durchschwei√üung", kritisch: true },
      "5011": { name: "Einbrandkerbe", gruppe: "5", beschreibung: "Kerbe an der Schwei√ünahtflanke", kritisch: false },
      "5012": { name: "Einbrandkerbe Wurzel", gruppe: "5", beschreibung: "Kerbe im Wurzelbereich", kritisch: false },
      "502": { name: "Naht√ºberh√∂hung", gruppe: "5", beschreibung: "Zu hohe Naht√ºberh√∂hung", kritisch: false },
      "503": { name: "Kantenversatz", gruppe: "5", beschreibung: "Versatz der F√ºgekanten", kritisch: false },
      "504": { name: "Decklagenunterw√∂lbung", gruppe: "5", beschreibung: "Zu geringe √úberh√∂hung", kritisch: false },
      "506": { name: "Z√ºndstelle", gruppe: "5", beschreibung: "Besch√§digung durch Lichtbogenz√ºndung", kritisch: false },
      "507": { name: "Schwei√üspritzer", gruppe: "5", beschreibung: "Anhaftende Metallspritzer", kritisch: false },
      "509": { name: "Nahtasymmetrie", gruppe: "5", beschreibung: "Asymmetrische Nahtausbildung", kritisch: false },
      "5213": { name: "Wurzelkerbe", gruppe: "5", beschreibung: "Kerbe im Wurzelbereich", kritisch: false },
      "601": { name: "Anlauffarben", gruppe: "6", beschreibung: "Oxidverf√§rbung durch W√§rme", kritisch: false }
    };

    // Status-Farben
    const getResultColor = (status) => {
      switch(status) {
        case 'Bestanden': case 'Bezahlt': return { bg: "#dcfce7", color: "#166534", border: "#22c55e" };
        case 'Nacharbeit': case 'In Bearbeitung': return { bg: "#fef3c7", color: "#92400e", border: "#f59e0b" };
        case 'Abgelehnt': return { bg: "#fee2e2", color: "#991b1b", border: "#ef4444" };
        case 'Verrechnet': return { bg: "#e0e7ff", color: "#3730a3", border: "#6366f1" };
        default: return { bg: "#f1f5f9", color: "#475569", border: "#94a3b8" };
      }
    };

    // Status Badge
    const StatusBadge = ({ status }) => {
      const colors = getResultColor(status);
      return (
        <span style={{ 
          background: colors.bg, color: colors.color, 
          padding: "3px 8px", borderRadius: "6px", 
          fontSize: "10px", fontWeight: 600, 
          border: `1px solid ${colors.border}` 
        }}>
          {status}
        </span>
      );
    };

    // Dashboard Karte
    const DashboardCard = ({ title, value, subtitle, icon, color }) => (
      <div style={{ 
        background: "#fff", borderRadius: "8px", padding: "24px", 
        boxShadow: "0 2px 8px rgba(0,0,0,0.06)", 
        borderLeft: `4px solid ${color}`,
        borderTop: "1px solid #e2e8f0",
        borderRight: "1px solid #e2e8f0",
        borderBottom: "1px solid #e2e8f0"
      }}>
        <div style={{ display: "flex", justifyContent: "space-between", alignItems: "start" }}>
          <div>
            <p style={{ fontSize: "12px", color: "#64748b", marginBottom: "8px", fontWeight: 500, textTransform: "uppercase", letterSpacing: "0.5px" }}>{title}</p>
            <p style={{ fontSize: "28px", fontWeight: 700, color: "#1e3a5f", margin: 0 }}>{value}</p>
            {subtitle && <p style={{ fontSize: "12px", color: "#64748b", marginTop: "8px" }}>{subtitle}</p>}
          </div>
          <div style={{ background: "#f8fafc", padding: "12px", borderRadius: "8px", border: "1px solid #e2e8f0" }}>
            <span style={{ fontSize: "24px", filter: "grayscale(30%)" }}>{icon}</span>
          </div>
        </div>
      </div>
    );

    // DOCX Generator - mit Library Check
    // DOCX Library dynamisch laden falls nicht vorhanden
    const loadDocxLibrary = () => {
      return new Promise((resolve, reject) => {
        if (typeof docx !== 'undefined' && docx.Document) {
          resolve();
          return;
        }
        
        // Fallback: Nochmal laden
        const script1 = document.createElement('script');
        script1.src = 'https://cdnjs.cloudflare.com/ajax/libs/docx/8.2.0/docx.min.js';
        script1.onload = () => {
          const script2 = document.createElement('script');
          script2.src = 'https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js';
          script2.onload = () => resolve();
          script2.onerror = () => reject(new Error('FileSaver konnte nicht geladen werden'));
          document.head.appendChild(script2);
        };
        script1.onerror = () => reject(new Error('DOCX Library konnte nicht geladen werden'));
        document.head.appendChild(script1);
      });
    };

    const generateGutachtenDOCX = async (gutachten) => {
      // Pr√ºfen ob Library geladen ist, sonst nachladen
      if (typeof docx === 'undefined' || !docx.Document) {
        try {
          alert('DOCX-Export wird vorbereitet...');
          await loadDocxLibrary();
          // Kurz warten bis alles initialisiert ist
          await new Promise(r => setTimeout(r, 500));
        } catch (error) {
          alert('Fehler beim Laden der DOCX-Bibliothek: ' + error.message);
          return;
        }
      }
      
      // Nochmal pr√ºfen
      if (typeof docx === 'undefined' || !docx.Document) {
        alert('DOCX-Bibliothek konnte nicht geladen werden. Bitte Seite neu laden.');
        return;
      }
      
      const { Document, Paragraph, TextRun, HeadingLevel, AlignmentType, BorderStyle, Table, TableRow, TableCell, WidthType } = docx;
      
      // Mechanische Pr√ºfungen formatieren
      const mechTests = gutachten.mechTests || {};
      const zfpPruefungen = [];
      const zerstoerPruefungen = [];
      
      if (mechTests.pt?.durchgefuehrt) {
        zfpPruefungen.push(`PT Farbeindringpr√ºfung: ${mechTests.pt.ergebnis || 'durchgef√ºhrt'}`);
      }
      if (mechTests.mt?.durchgefuehrt) {
        zfpPruefungen.push(`MT Magnetpulverpr√ºfung: ${mechTests.mt.ergebnis || 'durchgef√ºhrt'}`);
      }
      if (mechTests.ut?.durchgefuehrt) {
        zfpPruefungen.push(`UT Ultraschallpr√ºfung: ${mechTests.ut.ergebnis || 'durchgef√ºhrt'}`);
      }
      if (mechTests.haerte?.durchgefuehrt) {
        zerstoerPruefungen.push(`H√§rtepr√ºfung: ${mechTests.haerte.wert || '-'} ${mechTests.haerte.einheit || 'HV10'}`);
      }
      if (mechTests.zugversuch?.durchgefuehrt) {
        zerstoerPruefungen.push(`Zugversuch (Rm): ${mechTests.zugversuch.wert || '-'} N/mm¬≤`);
      }
      if (mechTests.biegeversuch?.durchgefuehrt) {
        zerstoerPruefungen.push(`Biegeversuch: ${mechTests.biegeversuch.ergebnis || 'durchgef√ºhrt'}`);
      }
      
      const docChildren = [
        new Paragraph({
          children: [new TextRun({ text: "GUTACHTEN SCHWEISSPR√úFUNG", bold: true, size: 32 })],
          heading: HeadingLevel.HEADING_1,
          alignment: AlignmentType.CENTER,
          spacing: { after: 400 }
        }),
        new Paragraph({
          children: [new TextRun({ text: `Gutachten-Nr: ${gutachten.gutachtenNr || 'N/A'}`, bold: true, size: 24 })],
          spacing: { after: 200 }
        }),
        new Paragraph({
          children: [new TextRun({ text: `Kunde: ${gutachten.kunde || 'N/A'}` })],
          spacing: { after: 100 }
        }),
        new Paragraph({
          children: [new TextRun({ text: `Datum: ${gutachten.datum || new Date().toLocaleDateString('de-AT')}` })],
          spacing: { after: 100 }
        }),
        new Paragraph({
          children: [new TextRun({ text: `Anzahl Fotos: ${gutachten.fotoCount || 1}` })],
          spacing: { after: 100 }
        }),
        new Paragraph({
          children: [new TextRun({ text: `Status: ${gutachten.status || 'Offen'}`, bold: true })],
          spacing: { after: 400 }
        }),
        // SICHTPR√úFUNG (KI-Analyse)
        new Paragraph({
          children: [new TextRun({ text: "1. SICHTPR√úFUNG (VT) - KI-ANALYSE", bold: true, size: 24 })],
          heading: HeadingLevel.HEADING_2,
          spacing: { before: 400, after: 200 }
        }),
        new Paragraph({
          children: [new TextRun({ text: "Anamnese (Was wurde gepr√ºft):", bold: true })],
          spacing: { after: 100 }
        }),
        new Paragraph({
          children: [new TextRun({ text: gutachten.anamnese || 'Keine Anamnese vorhanden' })],
          spacing: { after: 200 }
        }),
        new Paragraph({
          children: [new TextRun({ text: "Diagnose (Gefundene Fehler nach ISO 5817):", bold: true })],
          spacing: { after: 100 }
        }),
        new Paragraph({
          children: [new TextRun({ text: gutachten.diagnose || 'Keine Diagnose vorhanden' })],
          spacing: { after: 300 }
        })
      ];
      
      // ZfP Pr√ºfungen (wenn vorhanden)
      if (zfpPruefungen.length > 0) {
        docChildren.push(
          new Paragraph({
            children: [new TextRun({ text: "2. ZERST√ñRUNGSFREIE PR√úFUNGEN (ZfP)", bold: true, size: 24 })],
            heading: HeadingLevel.HEADING_2,
            spacing: { before: 400, after: 200 }
          })
        );
        zfpPruefungen.forEach(pruef => {
          docChildren.push(
            new Paragraph({
              children: [new TextRun({ text: `‚Ä¢ ${pruef}` })],
              spacing: { after: 100 }
            })
          );
        });
      }
      
      // Zerst√∂rende Pr√ºfungen (wenn vorhanden)
      if (zerstoerPruefungen.length > 0) {
        docChildren.push(
          new Paragraph({
            children: [new TextRun({ text: "3. ZERST√ñRENDE PR√úFUNGEN", bold: true, size: 24 })],
            heading: HeadingLevel.HEADING_2,
            spacing: { before: 400, after: 200 }
          })
        );
        zerstoerPruefungen.forEach(pruef => {
          docChildren.push(
            new Paragraph({
              children: [new TextRun({ text: `‚Ä¢ ${pruef}` })],
              spacing: { after: 100 }
            })
          );
        });
      }
      
      // Bemerkungen (wenn vorhanden)
      if (mechTests.bemerkungen) {
        docChildren.push(
          new Paragraph({
            children: [new TextRun({ text: "Bemerkungen zu Pr√ºfungen:", bold: true })],
            spacing: { before: 300, after: 100 }
          }),
          new Paragraph({
            children: [new TextRun({ text: mechTests.bemerkungen })],
            spacing: { after: 300 }
          })
        );
      }
      
      // GESAMTBEWERTUNG / CONCLUSIO
      docChildren.push(
        new Paragraph({
          children: [new TextRun({ text: "GESAMTBEWERTUNG (CONCLUSIO)", bold: true, size: 24 })],
          heading: HeadingLevel.HEADING_2,
          spacing: { before: 400, after: 200 }
        }),
        new Paragraph({
          children: [new TextRun({ text: gutachten.conclusio || 'Keine Conclusio vorhanden' })],
          spacing: { after: 400 }
        }),
        // Unterschrift
        new Paragraph({
          children: [new TextRun({ text: "___________________________", size: 20 })],
          alignment: AlignmentType.RIGHT,
          spacing: { before: 600 }
        }),
        new Paragraph({
          children: [new TextRun({ text: "Unterschrift Sachverst√§ndiger", size: 18, italics: true })],
          alignment: AlignmentType.RIGHT
        })
      );
      
      const doc = new Document({
        sections: [{
          properties: {},
          children: docChildren
        }]
      });

      const blob = await docx.Packer.toBlob(doc);
      saveAs(blob, `Gutachten_${gutachten.gutachtenNr || 'NEU'}_${new Date().toISOString().split('T')[0]}.docx`);
    };

    // Hauptkomponente
    function SchweissGutachterApp() {
      const [activeTab, setActiveTab] = useState('dashboard');
      const [gutachten, setGutachten] = useState([]);
      const [statusFilter, setStatusFilter] = useState(null); // Neu: Filter f√ºr Auftr√§ge
      const [stats, setStats] = useState({
        totalAuftraege: 0, offeneAuftraege: 0, abgeschlosseneAuftraege: 0,
        gesamtStunden: 0, gesamtUmsatz: 0, bezahlterUmsatz: 0, offenerUmsatz: 0,
        statusVerteilung: { offen: 0, inBearbeitung: 0, abgeschlossen: 0, verrechnet: 0, bezahlt: 0 }
      });
      const [loading, setLoading] = useState(false);
      const [analyzing, setAnalyzing] = useState(false);
      
      // Mehrere Bilder (bis zu 4)
      const [selectedImages, setSelectedImages] = useState([]);
      const [imagePreviews, setImagePreviews] = useState([]);
      
      const [analysisResult, setAnalysisResult] = useState(null);
      const [newGutachten, setNewGutachten] = useState({
        gutachtenNr: '',
        kunde: '',
        stunden: 0,
        stundensatz: 120,
        beschreibung: ''
      });
      
      // Mechanische Pr√ºfungen
      const [mechTests, setMechTests] = useState({
        pt: { durchgefuehrt: false, ergebnis: '' },      // Farbeindringpr√ºfung
        mt: { durchgefuehrt: false, ergebnis: '' },      // Magnetpulverpr√ºfung
        ut: { durchgefuehrt: false, ergebnis: '' },      // Ultraschallpr√ºfung
        haerte: { durchgefuehrt: false, wert: '', einheit: 'HV10' },
        zugversuch: { durchgefuehrt: false, wert: '', einheit: 'N/mm¬≤' },
        biegeversuch: { durchgefuehrt: false, ergebnis: '' },
        bemerkungen: ''
      });
      
      const [apiStatus, setApiStatus] = useState({ notion: false, anthropic: false, cloudinary: false });
      const fileInputRef = useRef(null);

      // API Status pr√ºfen
      useEffect(() => {
        fetch(`${API_BASE}/api/health`)
          .then(res => res.json())
          .then(data => setApiStatus({ notion: data.notion, anthropic: data.anthropic, cloudinary: data.cloudinary }))
          .catch(() => setApiStatus({ notion: false, anthropic: false, cloudinary: false }));
      }, []);

      const defaultStats = {
        totalAuftraege: 0, offeneAuftraege: 0, abgeschlosseneAuftraege: 0,
        gesamtStunden: 0, gesamtUmsatz: 0, bezahlterUmsatz: 0, offenerUmsatz: 0,
        statusVerteilung: { offen: 0, inBearbeitung: 0, abgeschlossen: 0, verrechnet: 0, bezahlt: 0 }
      };

      const loadData = () => {
        setLoading(true);
        fetch(`${API_BASE}/api/gutachten`)
          .then(r => r.json())
          .then(data => {
            if (data.success) setGutachten(data.gutachten || []);
          })
          .catch(e => console.error('Gutachten fetch error:', e));
        
        fetch(`${API_BASE}/api/dashboard`)
          .then(r => r.json())
          .then(data => {
            setStats(data.success ? data.stats : defaultStats);
            setLoading(false);
          })
          .catch(e => {
            console.error('Dashboard fetch error:', e);
            setStats(defaultStats);
            setLoading(false);
          });
      };

      // Daten laden
      useEffect(() => {
        loadData();
      }, []);

      // Bild ausw√§hlen
      // Bild(er) ausw√§hlen (bis zu 4)
      const handleImageSelect = (e) => {
        const files = Array.from(e.target.files);
        if (files.length > 0) {
          // Maximal 4 Bilder
          const newFiles = [...selectedImages, ...files].slice(0, 4);
          setSelectedImages(newFiles);
          setImagePreviews(newFiles.map(f => URL.createObjectURL(f)));
          setAnalysisResult(null);
        }
      };

      // Einzelnes Bild entfernen
      const removeImage = (index) => {
        const newImages = selectedImages.filter((_, i) => i !== index);
        const newPreviews = imagePreviews.filter((_, i) => i !== index);
        setSelectedImages(newImages);
        setImagePreviews(newPreviews);
      };

      // Alles zur√ºcksetzen (Reload-Funktion)
      const resetAnalysis = () => {
        setSelectedImages([]);
        setImagePreviews([]);
        setAnalysisResult(null);
        setMechTests({
          pt: { durchgefuehrt: false, ergebnis: '' },
          mt: { durchgefuehrt: false, ergebnis: '' },
          ut: { durchgefuehrt: false, ergebnis: '' },
          haerte: { durchgefuehrt: false, wert: '', einheit: 'HV10' },
          zugversuch: { durchgefuehrt: false, wert: '', einheit: 'N/mm¬≤' },
          biegeversuch: { durchgefuehrt: false, ergebnis: '' },
          bemerkungen: ''
        });
        if (fileInputRef.current) fileInputRef.current.value = '';
      };

      // Bilder analysieren (alle gleichzeitig an Claude senden)
      const analyzeImage = async () => {
        if (selectedImages.length === 0) return;
        
        setAnalyzing(true);
        try {
          const formData = new FormData();
          // Alle Bilder anh√§ngen
          selectedImages.forEach((img, index) => {
            formData.append('images', img);
          });

          const response = await fetch(`${API_BASE}/api/analyze`, {
            method: 'POST',
            body: formData
          });

          const data = await response.json();
          if (data.success) {
            setAnalysisResult(data.analysis);
          } else {
            alert('Analyse fehlgeschlagen: ' + data.error);
          }
        } catch (error) {
          console.error('Analyse-Fehler:', error);
          alert('Fehler bei der Analyse: ' + error.message);
        }
        setAnalyzing(false);
      };

      // Gutachten speichern (mit Cloudinary Bildupload - alle Bilder)
      const saveGutachten = async () => {
        try {
          let fotoUrls = [];
          
          // Alle Bilder zu Cloudinary hochladen
          for (const image of selectedImages) {
            const formData = new FormData();
            formData.append('image', image);
            
            const uploadResponse = await fetch(`${API_BASE}/api/upload-image`, {
              method: 'POST',
              body: formData
            });
            
            const uploadData = await uploadResponse.json();
            if (uploadData.success) {
              fotoUrls.push(uploadData.imageUrl);
              console.log('Bild hochgeladen:', uploadData.imageUrl);
            }
          }
          
          // Gutachten in Notion speichern
          const response = await fetch(`${API_BASE}/api/gutachten`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              ...newGutachten,
              gutachtenNr: newGutachten.gutachtenNr || `GA-${Date.now()}`,
              status: analysisResult?.status || 'Offen',
              beschreibung: analysisResult?.fullText || newGutachten.beschreibung,
              fotoUrl: fotoUrls[0] || null,  // Erstes Bild f√ºr Notion
              mechTests: mechTests  // Mechanische Tests mitspeichern
            })
          });

          const data = await response.json();
          if (data.success) {
            alert('Gutachten erfolgreich gespeichert!' + (fotoUrls.length > 0 ? ` (${fotoUrls.length} Foto(s))` : ''));
            loadData();
            resetAnalysis();
            setNewGutachten({ gutachtenNr: '', kunde: '', stunden: 0, stundensatz: 120, beschreibung: '' });
          }
        } catch (error) {
          console.error('Speichern fehlgeschlagen:', error);
          alert('Fehler beim Speichern: ' + error.message);
        }
      };

      // Status aktualisieren
      const updateStatus = async (id, newStatus) => {
        try {
          await fetch(`${API_BASE}/api/gutachten/${id}`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ id, status: newStatus })
          });
          loadData();
        } catch (error) {
          console.error('Status-Update fehlgeschlagen:', error);
        }
      };

      return (
        <div style={{ minHeight: "100vh", background: "#f8fafc" }}>
          {/* Header */}
          <header style={{ background: "linear-gradient(135deg, #1e3a5f 0%, #2c5282 100%)", padding: "20px 32px", borderBottom: "3px solid #c9a227" }}>
            <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", maxWidth: "1400px", margin: "0 auto" }}>
              <div style={{ display: "flex", alignItems: "center", gap: "20px" }}>
                <div style={{ background: "rgba(255,255,255,0.1)", padding: "14px", borderRadius: "8px", border: "1px solid rgba(255,255,255,0.2)" }}>
                  <span style={{ fontSize: "28px" }}>&#9878;</span>
                </div>
                <div>
                  <h1 style={{ color: "#fff", fontSize: "24px", margin: 0, fontWeight: 600, letterSpacing: "0.5px", fontFamily: "Georgia, serif" }}>SV Gutachten Schweisstechnik</h1>
                  <p style={{ color: "rgba(255,255,255,0.7)", fontSize: "12px", margin: "6px 0 0", letterSpacing: "1px", textTransform: "uppercase" }}>Sachverstaendigenbuero | ISO 5817 | ISO 17637</p>
                </div>
              </div>
              <div style={{ textAlign: "right" }}>
                <p style={{ color: "#c9a227", fontSize: "13px", margin: 0, fontWeight: 500, fontStyle: "italic" }}>Projektdesign</p>
                <p style={{ color: "#fff", fontSize: "15px", margin: "4px 0 0", fontWeight: 600 }}>Dr. Christian Kovac</p>
              </div>
            </div>
          </header>

          {/* Navigation */}
          <nav style={{ background: "#fff", padding: "0 16px", boxShadow: "0 2px 8px rgba(0,0,0,0.08)", borderBottom: "1px solid #e2e8f0", overflowX: "auto", WebkitOverflowScrolling: "touch" }}>
            <div style={{ display: "flex", gap: "0", maxWidth: "1400px", margin: "0 auto", minWidth: "max-content" }}>
              {[
                { id: 'dashboard', label: 'üìä Dashboard' },
                { id: 'analyse', label: 'üîç Analyse' },
                { id: 'auftraege', label: 'üìã Auftr√§ge' },
                { id: 'fehlerkatalog', label: 'üìñ Katalog' }
              ].map(tab => (
                <button
                  key={tab.id}
                  onClick={() => setActiveTab(tab.id)}
                  style={{
                    padding: "16px 20px",
                    background: activeTab === tab.id ? "#1e3a5f" : "transparent",
                    color: activeTab === tab.id ? "#fff" : "#475569",
                    border: "none",
                    borderBottom: activeTab === tab.id ? "3px solid #c9a227" : "3px solid transparent",
                    cursor: "pointer",
                    fontSize: "14px",
                    fontWeight: 600,
                    letterSpacing: "0.3px",
                    transition: "all 0.2s ease",
                    minHeight: "52px",
                    WebkitTapHighlightColor: "transparent",
                    touchAction: "manipulation",
                    whiteSpace: "nowrap"
                  }}
                >
                  {tab.label}
                </button>
              ))}
            </div>
          </nav>

          {/* Content */}
          <main style={{ padding: "16px", maxWidth: "1400px", margin: "0 auto" }}>
            
            {/* DASHBOARD TAB */}
            {activeTab === 'dashboard' && (
              <div>
                <div className="dashboard-grid">
                  <DashboardCard 
                    title="Gesamt Auftr√§ge" 
                    value={stats.totalAuftraege} 
                    subtitle={`${stats.offeneAuftraege} offen`}
                    icon="üìã" 
                    color="#3b82f6" 
                  />
                  <DashboardCard 
                    title="Geleistete Stunden" 
                    value={stats.gesamtStunden.toFixed(1)} 
                    subtitle="Stunden gesamt"
                    icon="‚è±Ô∏è" 
                    color="#8b5cf6" 
                  />
                  <DashboardCard 
                    title="Gesamt Umsatz" 
                    value={`‚Ç¨ ${stats.gesamtUmsatz.toLocaleString('de-AT')}`} 
                    subtitle={`‚Ç¨ ${stats.bezahlterUmsatz.toLocaleString('de-AT')} bezahlt`}
                    icon="üí∞" 
                    color="#22c55e" 
                  />
                  <DashboardCard 
                    title="Offene Forderungen" 
                    value={`‚Ç¨ ${stats.offenerUmsatz.toLocaleString('de-AT')}`} 
                    subtitle="noch nicht bezahlt"
                    icon="üì®" 
                    color="#f97316" 
                  />
                </div>

                <div style={{ background: "#fff", borderRadius: "20px", padding: "28px", boxShadow: "0 4px 20px rgba(0,0,0,0.06)", border: "1px solid #e0f2fe" }}>
                  <h3 style={{ margin: "0 0 20px", fontSize: "18px", color: "#0c4a6e", fontWeight: 700 }}>Status-Verteilung</h3>
                  <div className="status-grid">
                    {Object.entries(stats.statusVerteilung).map(([status, count]) => {
                      const labels = { offen: 'Offen', inBearbeitung: 'In Bearbeitung', abgeschlossen: 'Abgeschlossen', verrechnet: 'Verrechnet', bezahlt: 'Bezahlt' };
                      const colors = getResultColor(labels[status]);
                      return (
                        <div 
                          key={status} 
                          onClick={() => {
                            setStatusFilter(labels[status]);
                            setActiveTab('auftraege');
                          }}
                          style={{ 
                            flex: 1, background: colors.bg, borderRadius: "8px", 
                            padding: "16px", textAlign: "center", border: `1px solid ${colors.border}`,
                            cursor: "pointer", transition: "transform 0.15s, box-shadow 0.15s",
                            minHeight: "44px", touchAction: "manipulation"
                          }}
                          onMouseEnter={(e) => { e.currentTarget.style.transform = "translateY(-2px)"; e.currentTarget.style.boxShadow = "0 4px 12px rgba(0,0,0,0.15)"; }}
                          onMouseLeave={(e) => { e.currentTarget.style.transform = "translateY(0)"; e.currentTarget.style.boxShadow = "none"; }}
                        >
                          <p style={{ fontSize: "24px", fontWeight: 700, color: colors.color, margin: 0 }}>{count}</p>
                          <p style={{ fontSize: "11px", color: colors.color, margin: "4px 0 0" }}>{labels[status]}</p>
                        </div>
                      );
                    })}
                  </div>
                </div>
              </div>
            )}

            {/* ANALYSE TAB */}
            {activeTab === 'analyse' && (
              <div className="analyse-grid">
                {/* Linke Seite: Upload + Bilder */}
                <div>
                  <div style={{ background: "#fff", borderRadius: "12px", padding: "24px", boxShadow: "0 2px 8px rgba(0,0,0,0.08)" }}>
                    <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: "16px" }}>
                      <h3 style={{ margin: 0, fontSize: "16px" }}>üì∑ Fotos (bis zu 4)</h3>
                      {(selectedImages.length > 0 || analysisResult) && (
                        <button 
                          onClick={resetAnalysis}
                          style={{ 
                            padding: "8px 16px", background: "#ef4444", color: "#fff",
                            border: "none", borderRadius: "6px", fontSize: "13px", 
                            cursor: "pointer", display: "flex", alignItems: "center", gap: "6px"
                          }}
                        >
                          üîÑ Neu starten
                        </button>
                      )}
                    </div>
                    
                    <input 
                      type="file" 
                      ref={fileInputRef}
                      accept="image/*"
                      capture="environment"
                      multiple
                      onChange={handleImageSelect}
                      style={{ display: "none" }}
                    />
                    
                    {/* Bild-Vorschauen Grid */}
                    {imagePreviews.length > 0 ? (
                      <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: "12px", marginBottom: "16px" }}>
                        {imagePreviews.map((preview, index) => (
                          <div key={index} style={{ position: "relative" }}>
                            <img 
                              src={preview} 
                              alt={`Foto ${index + 1}`} 
                              style={{ width: "100%", height: "150px", objectFit: "cover", borderRadius: "8px", border: "2px solid #e2e8f0" }} 
                            />
                            <button
                              onClick={() => removeImage(index)}
                              style={{
                                position: "absolute", top: "8px", right: "8px",
                                background: "#ef4444", color: "#fff", border: "none",
                                borderRadius: "50%", width: "28px", height: "28px",
                                cursor: "pointer", fontSize: "14px"
                              }}
                            >‚úï</button>
                            <span style={{
                              position: "absolute", bottom: "8px", left: "8px",
                              background: "rgba(0,0,0,0.7)", color: "#fff",
                              padding: "4px 8px", borderRadius: "4px", fontSize: "11px"
                            }}>
                              {index === 0 ? "Draufsicht" : index === 1 ? "Wurzelseite" : index === 2 ? "Seitenansicht" : "Detail"}
                            </span>
                          </div>
                        ))}
                        {analyzing && <div className="scan-line"></div>}
                      </div>
                    ) : null}
                    
                    {/* Upload Button - nur wenn weniger als 4 Bilder */}
                    {selectedImages.length < 4 && (
                      <div 
                        onClick={() => fileInputRef.current?.click()}
                        onTouchEnd={(e) => { e.preventDefault(); fileInputRef.current?.click(); }}
                        style={{ 
                          border: "2px dashed #cbd5e1", borderRadius: "12px", 
                          padding: selectedImages.length > 0 ? "20px" : "40px", 
                          textAlign: "center", cursor: "pointer",
                          background: "#f8fafc",
                          WebkitTapHighlightColor: "rgba(0,0,0,0.1)",
                          touchAction: "manipulation",
                          minHeight: selectedImages.length > 0 ? "80px" : "200px"
                        }}
                      >
                        <span style={{ fontSize: selectedImages.length > 0 ? "32px" : "48px" }}>üì∑</span>
                        <p style={{ color: "#64748b", marginTop: "8px", marginBottom: 0 }}>
                          {selectedImages.length === 0 ? "Fotos hochladen" : `+ Weitere hinzuf√ºgen (${4 - selectedImages.length} √ºbrig)`}
                        </p>
                        {selectedImages.length === 0 && (
                          <p style={{ color: "#94a3b8", fontSize: "12px", margin: "8px 0 0" }}>
                            Draufsicht, Wurzelseite, Seitenansicht, Detail
                          </p>
                        )}
                      </div>
                    )}

                    <button 
                      onClick={analyzeImage}
                      disabled={selectedImages.length === 0 || analyzing}
                      style={{ 
                        width: "100%", marginTop: "16px", padding: "14px",
                        background: analyzing ? "#94a3b8" : "linear-gradient(135deg, #f97316, #ea580c)",
                        color: "#fff", border: "none", borderRadius: "8px",
                        fontSize: "14px", fontWeight: 600, 
                        cursor: selectedImages.length > 0 ? "pointer" : "not-allowed",
                        minHeight: "48px", touchAction: "manipulation"
                      }}
                    >
                      {analyzing ? (
                        <><span className="loading"></span> Analysiere {selectedImages.length} Foto(s)...</>
                      ) : (
                        `ü§ñ ${selectedImages.length} Foto(s) analysieren`
                      )}
                    </button>
                  </div>

                  {/* Mechanische Pr√ºfungen */}
                  <div style={{ background: "#fff", borderRadius: "12px", padding: "24px", marginTop: "20px", boxShadow: "0 2px 8px rgba(0,0,0,0.08)" }}>
                    <h3 style={{ margin: "0 0 16px", fontSize: "16px" }}>üîß Mechanische Pr√ºfungen</h3>
                    
                    {/* ZfP Pr√ºfungen */}
                    <div style={{ marginBottom: "16px" }}>
                      <p style={{ fontSize: "12px", color: "#64748b", marginBottom: "8px", fontWeight: 600 }}>Zerst√∂rungsfreie Pr√ºfungen (ZfP)</p>
                      
                      {/* PT - Farbeindringpr√ºfung */}
                      <div style={{ display: "flex", alignItems: "center", gap: "12px", marginBottom: "8px", padding: "10px", background: "#f8fafc", borderRadius: "6px" }}>
                        <input 
                          type="checkbox" 
                          checked={mechTests.pt.durchgefuehrt}
                          onChange={e => setMechTests({...mechTests, pt: {...mechTests.pt, durchgefuehrt: e.target.checked}})}
                          style={{ width: "18px", height: "18px" }}
                        />
                        <span style={{ flex: 1, fontSize: "13px" }}>PT Farbeindringpr√ºfung</span>
                        <select 
                          value={mechTests.pt.ergebnis}
                          onChange={e => setMechTests({...mechTests, pt: {...mechTests.pt, ergebnis: e.target.value}})}
                          disabled={!mechTests.pt.durchgefuehrt}
                          style={{ padding: "6px 10px", borderRadius: "4px", border: "1px solid #e2e8f0", fontSize: "13px" }}
                        >
                          <option value="">--</option>
                          <option value="i.O.">i.O.</option>
                          <option value="n.i.O.">n.i.O.</option>
                        </select>
                      </div>

                      {/* MT - Magnetpulverpr√ºfung */}
                      <div style={{ display: "flex", alignItems: "center", gap: "12px", marginBottom: "8px", padding: "10px", background: "#f8fafc", borderRadius: "6px" }}>
                        <input 
                          type="checkbox" 
                          checked={mechTests.mt.durchgefuehrt}
                          onChange={e => setMechTests({...mechTests, mt: {...mechTests.mt, durchgefuehrt: e.target.checked}})}
                          style={{ width: "18px", height: "18px" }}
                        />
                        <span style={{ flex: 1, fontSize: "13px" }}>MT Magnetpulverpr√ºfung</span>
                        <select 
                          value={mechTests.mt.ergebnis}
                          onChange={e => setMechTests({...mechTests, mt: {...mechTests.mt, ergebnis: e.target.value}})}
                          disabled={!mechTests.mt.durchgefuehrt}
                          style={{ padding: "6px 10px", borderRadius: "4px", border: "1px solid #e2e8f0", fontSize: "13px" }}
                        >
                          <option value="">--</option>
                          <option value="i.O.">i.O.</option>
                          <option value="n.i.O.">n.i.O.</option>
                        </select>
                      </div>

                      {/* UT - Ultraschallpr√ºfung */}
                      <div style={{ display: "flex", alignItems: "center", gap: "12px", marginBottom: "8px", padding: "10px", background: "#f8fafc", borderRadius: "6px" }}>
                        <input 
                          type="checkbox" 
                          checked={mechTests.ut.durchgefuehrt}
                          onChange={e => setMechTests({...mechTests, ut: {...mechTests.ut, durchgefuehrt: e.target.checked}})}
                          style={{ width: "18px", height: "18px" }}
                        />
                        <span style={{ flex: 1, fontSize: "13px" }}>UT Ultraschallpr√ºfung</span>
                        <select 
                          value={mechTests.ut.ergebnis}
                          onChange={e => setMechTests({...mechTests, ut: {...mechTests.ut, ergebnis: e.target.value}})}
                          disabled={!mechTests.ut.durchgefuehrt}
                          style={{ padding: "6px 10px", borderRadius: "4px", border: "1px solid #e2e8f0", fontSize: "13px" }}
                        >
                          <option value="">--</option>
                          <option value="i.O.">i.O.</option>
                          <option value="n.i.O.">n.i.O.</option>
                        </select>
                      </div>
                    </div>

                    {/* Zerst√∂rende Pr√ºfungen */}
                    <div style={{ marginBottom: "16px" }}>
                      <p style={{ fontSize: "12px", color: "#64748b", marginBottom: "8px", fontWeight: 600 }}>Zerst√∂rende Pr√ºfungen</p>
                      
                      {/* H√§rtepr√ºfung */}
                      <div style={{ display: "flex", alignItems: "center", gap: "12px", marginBottom: "8px", padding: "10px", background: "#f8fafc", borderRadius: "6px" }}>
                        <input 
                          type="checkbox" 
                          checked={mechTests.haerte.durchgefuehrt}
                          onChange={e => setMechTests({...mechTests, haerte: {...mechTests.haerte, durchgefuehrt: e.target.checked}})}
                          style={{ width: "18px", height: "18px" }}
                        />
                        <span style={{ flex: 1, fontSize: "13px" }}>H√§rtepr√ºfung</span>
                        <input 
                          type="number"
                          placeholder="Wert"
                          value={mechTests.haerte.wert}
                          onChange={e => setMechTests({...mechTests, haerte: {...mechTests.haerte, wert: e.target.value}})}
                          disabled={!mechTests.haerte.durchgefuehrt}
                          style={{ width: "70px", padding: "6px", borderRadius: "4px", border: "1px solid #e2e8f0", fontSize: "13px" }}
                        />
                        <select 
                          value={mechTests.haerte.einheit}
                          onChange={e => setMechTests({...mechTests, haerte: {...mechTests.haerte, einheit: e.target.value}})}
                          disabled={!mechTests.haerte.durchgefuehrt}
                          style={{ padding: "6px", borderRadius: "4px", border: "1px solid #e2e8f0", fontSize: "13px" }}
                        >
                          <option value="HV10">HV10</option>
                          <option value="HV5">HV5</option>
                          <option value="HRC">HRC</option>
                          <option value="HB">HB</option>
                        </select>
                      </div>

                      {/* Zugversuch */}
                      <div style={{ display: "flex", alignItems: "center", gap: "12px", marginBottom: "8px", padding: "10px", background: "#f8fafc", borderRadius: "6px" }}>
                        <input 
                          type="checkbox" 
                          checked={mechTests.zugversuch.durchgefuehrt}
                          onChange={e => setMechTests({...mechTests, zugversuch: {...mechTests.zugversuch, durchgefuehrt: e.target.checked}})}
                          style={{ width: "18px", height: "18px" }}
                        />
                        <span style={{ flex: 1, fontSize: "13px" }}>Zugversuch</span>
                        <input 
                          type="number"
                          placeholder="Rm"
                          value={mechTests.zugversuch.wert}
                          onChange={e => setMechTests({...mechTests, zugversuch: {...mechTests.zugversuch, wert: e.target.value}})}
                          disabled={!mechTests.zugversuch.durchgefuehrt}
                          style={{ width: "70px", padding: "6px", borderRadius: "4px", border: "1px solid #e2e8f0", fontSize: "13px" }}
                        />
                        <span style={{ fontSize: "13px", color: "#64748b" }}>N/mm¬≤</span>
                      </div>

                      {/* Biegeversuch */}
                      <div style={{ display: "flex", alignItems: "center", gap: "12px", marginBottom: "8px", padding: "10px", background: "#f8fafc", borderRadius: "6px" }}>
                        <input 
                          type="checkbox" 
                          checked={mechTests.biegeversuch.durchgefuehrt}
                          onChange={e => setMechTests({...mechTests, biegeversuch: {...mechTests.biegeversuch, durchgefuehrt: e.target.checked}})}
                          style={{ width: "18px", height: "18px" }}
                        />
                        <span style={{ flex: 1, fontSize: "13px" }}>Biegeversuch</span>
                        <select 
                          value={mechTests.biegeversuch.ergebnis}
                          onChange={e => setMechTests({...mechTests, biegeversuch: {...mechTests.biegeversuch, ergebnis: e.target.value}})}
                          disabled={!mechTests.biegeversuch.durchgefuehrt}
                          style={{ padding: "6px 10px", borderRadius: "4px", border: "1px solid #e2e8f0", fontSize: "13px" }}
                        >
                          <option value="">--</option>
                          <option value="bestanden">bestanden</option>
                          <option value="nicht bestanden">nicht bestanden</option>
                        </select>
                      </div>
                    </div>

                    {/* Bemerkungen */}
                    <div>
                      <label style={{ fontSize: "12px", color: "#64748b" }}>Bemerkungen zu Pr√ºfungen</label>
                      <textarea 
                        placeholder="Zus√§tzliche Anmerkungen..."
                        value={mechTests.bemerkungen}
                        onChange={e => setMechTests({...mechTests, bemerkungen: e.target.value})}
                        style={{ 
                          width: "100%", padding: "10px", border: "1px solid #e2e8f0", 
                          borderRadius: "6px", marginTop: "4px", minHeight: "60px", 
                          fontSize: "13px", resize: "vertical" 
                        }}
                      />
                    </div>
                  </div>

                  {/* Gutachten-Daten */}
                  <div style={{ background: "#fff", borderRadius: "12px", padding: "24px", marginTop: "20px", boxShadow: "0 2px 8px rgba(0,0,0,0.08)" }}>
                    <h3 style={{ margin: "0 0 16px", fontSize: "16px" }}>üìù Gutachten-Daten</h3>
                    
                    <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: "12px" }}>
                      <div>
                        <label style={{ fontSize: "12px", color: "#64748b" }}>Gutachten-Nr</label>
                        <input 
                          type="text" 
                          placeholder="z.B. PA-2024-0044"
                          value={newGutachten.gutachtenNr}
                          onChange={e => setNewGutachten({...newGutachten, gutachtenNr: e.target.value})}
                          style={{ width: "100%", padding: "10px", border: "1px solid #e2e8f0", borderRadius: "6px", marginTop: "4px" }}
                        />
                      </div>
                      <div>
                        <label style={{ fontSize: "12px", color: "#64748b" }}>Kunde</label>
                        <input 
                          type="text" 
                          placeholder="Kundenname"
                          value={newGutachten.kunde}
                          onChange={e => setNewGutachten({...newGutachten, kunde: e.target.value})}
                          style={{ width: "100%", padding: "10px", border: "1px solid #e2e8f0", borderRadius: "6px", marginTop: "4px" }}
                        />
                      </div>
                      <div>
                        <label style={{ fontSize: "12px", color: "#64748b" }}>Stunden</label>
                        <input 
                          type="number" 
                          value={newGutachten.stunden}
                          onChange={e => setNewGutachten({...newGutachten, stunden: parseFloat(e.target.value) || 0})}
                          style={{ width: "100%", padding: "10px", border: "1px solid #e2e8f0", borderRadius: "6px", marginTop: "4px" }}
                        />
                      </div>
                      <div>
                        <label style={{ fontSize: "12px", color: "#64748b" }}>Stundensatz (‚Ç¨)</label>
                        <input 
                          type="number" 
                          value={newGutachten.stundensatz}
                          onChange={e => setNewGutachten({...newGutachten, stundensatz: parseFloat(e.target.value) || 0})}
                          style={{ width: "100%", padding: "10px", border: "1px solid #e2e8f0", borderRadius: "6px", marginTop: "4px" }}
                        />
                      </div>
                    </div>

                    <button 
                      onClick={saveGutachten}
                      disabled={!analysisResult}
                      style={{ 
                        width: "100%", marginTop: "16px", padding: "14px",
                        background: analysisResult ? "linear-gradient(135deg, #22c55e, #16a34a)" : "#94a3b8",
                        color: "#fff", border: "none", borderRadius: "8px",
                        fontSize: "14px", fontWeight: 600, cursor: analysisResult ? "pointer" : "not-allowed"
                      }}
                    >
                      üíæ In Datenbank speichern
                    </button>
                  </div>
                </div>

                {/* Rechte Seite: Analyse-Ergebnis */}
                <div style={{ background: "#fff", borderRadius: "12px", padding: "24px", boxShadow: "0 2px 8px rgba(0,0,0,0.08)" }}>
                  <h3 style={{ margin: "0 0 16px", fontSize: "16px" }}>üìã Analyse-Ergebnis</h3>
                  
                  {analysisResult ? (
                    <>
                      <div style={{ 
                        background: getResultColor(analysisResult.status).bg, 
                        padding: "12px 16px", borderRadius: "8px", marginBottom: "16px",
                        border: `2px solid ${getResultColor(analysisResult.status).border}`
                      }}>
                        <span style={{ fontSize: "18px", fontWeight: 700, color: getResultColor(analysisResult.status).color }}>
                          {analysisResult.status === 'Bestanden' ? '‚úì BESTANDEN' : 
                           analysisResult.status === 'Nacharbeit' ? '‚ö† NACHARBEIT ERFORDERLICH' : '‚úó ABGELEHNT'}
                        </span>
                      </div>

                      {[
                        { title: 'ANAMNESE', content: analysisResult.anamnese, color: '#3b82f6', icon: 'üîç' },
                        { title: 'DIAGNOSE', content: analysisResult.diagnose, color: '#f97316', icon: '‚öñÔ∏è' },
                        { title: 'CONCLUSIO', content: analysisResult.conclusio, color: getResultColor(analysisResult.status).border, icon: 'üìã' }
                      ].map((section, i) => (
                        <div key={i} style={{ marginBottom: "16px" }}>
                          <h4 style={{ fontSize: "12px", color: section.color, margin: "0 0 8px", display: "flex", alignItems: "center", gap: "6px" }}>
                            <span>{section.icon}</span> {section.title}
                          </h4>
                          <pre style={{ 
                            fontSize: "11px", whiteSpace: "pre-wrap", 
                            background: "#f8fafc", padding: "12px", borderRadius: "6px",
                            borderLeft: `3px solid ${section.color}`,
                            maxHeight: "150px", overflow: "auto", margin: 0
                          }}>
                            {section.content || 'Keine Daten'}
                          </pre>
                        </div>
                      ))}

                      <button 
                        onClick={() => generateGutachtenDOCX({
                          gutachtenNr: newGutachten.gutachtenNr || `GA-${Date.now()}`,
                          kunde: newGutachten.kunde,
                          datum: new Date().toISOString().split('T')[0],
                          status: analysisResult.status,
                          anamnese: analysisResult.anamnese,
                          diagnose: analysisResult.diagnose,
                          conclusio: analysisResult.conclusio,
                          mechTests: mechTests,
                          fotoCount: selectedImages.length
                        })}
                        style={{ 
                          width: "100%", padding: "14px",
                          background: "linear-gradient(135deg, #6366f1, #4f46e5)",
                          color: "#fff", border: "none", borderRadius: "8px",
                          fontSize: "14px", fontWeight: 600, cursor: "pointer",
                          minHeight: "48px",
                          WebkitTapHighlightColor: "transparent",
                          touchAction: "manipulation"
                        }}
                      >
                        üìÑ Gesamtgutachten als DOCX exportieren
                      </button>
                    </>
                  ) : (
                    <div style={{ textAlign: "center", padding: "60px 20px", color: "#94a3b8" }}>
                      <span style={{ fontSize: "48px" }}>üî¨</span>
                      <p style={{ marginTop: "16px" }}>Lade bis zu 4 Fotos hoch und starte die KI-Analyse</p>
                      <p style={{ fontSize: "12px", marginTop: "8px" }}>Draufsicht ‚Ä¢ Wurzelseite ‚Ä¢ Seitenansicht ‚Ä¢ Detail</p>
                    </div>
                  )}
                </div>
              </div>
            )}

            {/* AUFTR√ÑGE TAB */}
            {activeTab === 'auftraege' && (
              <div style={{ background: "#fff", borderRadius: "12px", padding: "24px", boxShadow: "0 2px 8px rgba(0,0,0,0.08)" }}>
                <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: "20px", flexWrap: "wrap", gap: "12px" }}>
                  <h3 style={{ margin: 0, fontSize: "18px" }}>
                    üìã {statusFilter ? `Auftr√§ge: ${statusFilter}` : 'Alle Auftr√§ge'}
                  </h3>
                  <div style={{ display: "flex", gap: "8px" }}>
                    {statusFilter && (
                      <button 
                        onClick={() => setStatusFilter(null)}
                        style={{ padding: "12px 20px", background: "#ef4444", color: "#fff", border: "none", borderRadius: "8px", cursor: "pointer", fontSize: "14px", fontWeight: 500, minHeight: "44px", WebkitTapHighlightColor: "transparent", touchAction: "manipulation" }}
                      >
                        ‚úï Filter zur√ºcksetzen
                      </button>
                    )}
                    <button 
                      onClick={loadData}
                      style={{ padding: "12px 20px", background: "#f1f5f9", border: "none", borderRadius: "8px", cursor: "pointer", fontSize: "14px", fontWeight: 500, minHeight: "44px", WebkitTapHighlightColor: "transparent", touchAction: "manipulation" }}
                    >
                      üîÑ Aktualisieren
                    </button>
                  </div>
                </div>

                {loading ? (
                  <div style={{ textAlign: "center", padding: "40px" }}>
                    <div className="loading" style={{ borderColor: "#f97316", borderTopColor: "transparent" }}></div>
                  </div>
                ) : gutachten.filter(g => !statusFilter || g.status === statusFilter).length > 0 ? (
                  <div style={{ display: "flex", flexDirection: "column", gap: "16px" }}>
                    {gutachten.filter(g => !statusFilter || g.status === statusFilter).map(g => (
                      <div 
                        key={g.id}
                        style={{ 
                          padding: "20px", 
                          borderRadius: "12px",
                          background: "#f8fafc",
                          border: "1px solid #e2e8f0"
                        }}
                      >
                        {/* Header mit Nr und Status */}
                        <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: "12px" }}>
                          <span style={{ fontWeight: 700, fontSize: "18px", color: "#1e3a5f" }}>{g.gutachtenNr}</span>
                          <StatusBadge status={g.status} />
                        </div>
                        
                        {/* Kunde und Datum */}
                        <div style={{ marginBottom: "16px" }}>
                          <p style={{ margin: "0 0 4px", fontSize: "16px", fontWeight: 500 }}>{g.kunde || "Kein Kunde"}</p>
                          <p style={{ margin: 0, fontSize: "14px", color: "#64748b" }}>{g.datum || "Kein Datum"}</p>
                        </div>
                        
                        {/* Stunden und Umsatz */}
                        <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: "16px", paddingTop: "16px", borderTop: "1px solid #e2e8f0" }}>
                          <div>
                            <span style={{ fontSize: "13px", color: "#64748b" }}>Stunden: </span>
                            <span style={{ fontWeight: 600, fontSize: "15px" }}>{g.stunden}h</span>
                          </div>
                          <div>
                            <span style={{ fontSize: "13px", color: "#64748b" }}>Umsatz: </span>
                            <span style={{ fontWeight: 700, fontSize: "16px", color: "#166534" }}>‚Ç¨ {g.umsatz.toLocaleString('de-AT')}</span>
                          </div>
                          <div>
                            <span style={{ fontSize: "24px" }}>{g.bezahlt ? "‚úÖ" : "‚è≥"}</span>
                          </div>
                        </div>
                        
                        {/* Status-Buttons */}
                        <div style={{ display: "flex", gap: "8px", flexWrap: "wrap", marginBottom: "16px" }}>
                          {["Offen", "In Bearbeitung", "Abgeschlossen", "Verrechnet", "Bezahlt"].map(status => (
                            <button
                              key={status}
                              onClick={() => updateStatus(g.id, status)}
                              style={{ 
                                padding: "12px 16px", 
                                fontSize: "13px", 
                                fontWeight: 500,
                                border: g.status === status ? "2px solid #1e3a5f" : "1px solid #cbd5e1",
                                borderRadius: "8px",
                                background: g.status === status ? "#e0f2fe" : "#fff",
                                color: g.status === status ? "#1e3a5f" : "#475569",
                                cursor: "pointer",
                                WebkitTapHighlightColor: "transparent",
                                touchAction: "manipulation",
                                minHeight: "44px"
                              }}
                            >
                              {status}
                            </button>
                          ))}
                        </div>
                        
                        {/* Link zu Notion */}
                        {g.url && (
                          <a 
                            href={g.url} 
                            target="_blank" 
                            rel="noopener noreferrer"
                            style={{ 
                              display: "block",
                              padding: "14px 20px",
                              background: "#1e3a5f",
                              color: "#fff",
                              textDecoration: "none",
                              borderRadius: "8px",
                              fontSize: "14px",
                              fontWeight: 600,
                              textAlign: "center",
                              WebkitTapHighlightColor: "transparent",
                              touchAction: "manipulation",
                              minHeight: "44px"
                            }}
                          >
                            üìÑ In Datenbank √∂ffnen
                          </a>
                        )}
                      </div>
                    ))}
                  </div>
                ) : (
                  <div style={{ textAlign: "center", padding: "60px", color: "#94a3b8" }}>
                    <p>{statusFilter ? `Keine Auftr√§ge mit Status "${statusFilter}"` : 'Noch keine Gutachten vorhanden'}</p>
                    <p style={{ fontSize: "12px" }}>
                      {statusFilter ? (
                        <button 
                          onClick={() => setStatusFilter(null)}
                          style={{ background: "none", border: "none", color: "#3b82f6", cursor: "pointer", textDecoration: "underline" }}
                        >
                          Alle Auftr√§ge anzeigen
                        </button>
                      ) : 'Erstelle dein erstes Gutachten im Tab "Analyse"'}
                    </p>
                  </div>
                )}
              </div>
            )}

            {/* FEHLERKATALOG TAB */}
            {activeTab === 'fehlerkatalog' && (
              <div style={{ background: "#fff", borderRadius: "12px", padding: "24px", boxShadow: "0 2px 8px rgba(0,0,0,0.08)" }}>
                <h3 style={{ margin: "0 0 20px", fontSize: "18px" }}>üìñ Schwei√üfehler-Katalog nach ISO 5817</h3>
                
                <div className="katalog-grid">
                  {Object.entries(FEHLERKATALOG).map(([code, fehler]) => (
                    <div 
                      key={code}
                      style={{ 
                        padding: "16px", borderRadius: "8px",
                        background: fehler.kritisch ? "#fef2f2" : "#f8fafc",
                        border: `1px solid ${fehler.kritisch ? "#fecaca" : "#e2e8f0"}`
                      }}
                    >
                      <div style={{ display: "flex", justifyContent: "space-between", alignItems: "start", marginBottom: "8px" }}>
                        <span style={{ fontWeight: 700, fontSize: "14px" }}>{code}</span>
                        {fehler.kritisch && (
                          <span style={{ background: "#ef4444", color: "#fff", padding: "2px 6px", borderRadius: "4px", fontSize: "9px" }}>
                            KRITISCH
                          </span>
                        )}
                      </div>
                      <p style={{ fontWeight: 600, fontSize: "13px", margin: "0 0 4px" }}>{fehler.name}</p>
                      <p style={{ fontSize: "11px", color: "#64748b", margin: 0 }}>{fehler.beschreibung}</p>
                      <span style={{ 
                        display: "inline-block", marginTop: "8px",
                        background: "#e0e7ff", color: "#3730a3", 
                        padding: "2px 6px", borderRadius: "4px", fontSize: "10px" 
                      }}>
                        Gruppe {fehler.gruppe}
                      </span>
                    </div>
                  ))}
                </div>
              </div>
            )}

          </main>

          {/* Footer */}
          <footer style={{ padding: "20px 32px", background: "#1e3a5f", marginTop: "40px", borderTop: "3px solid #c9a227" }}>
            <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", maxWidth: "1400px", margin: "0 auto" }}>
              <p style={{ fontSize: "11px", color: "rgba(255,255,255,0.6)", margin: 0 }}>
                SV Gutachten Schweisstechnik | Version 8.0 | Multi-Bild + ZfP | ISO 5817 / ISO 17637 konform | 2025
              </p>
              <div style={{ display: "flex", gap: "16px", alignItems: "center" }}>
                <div style={{ display: "flex", alignItems: "center", gap: "5px" }}>
                  <span style={{ 
                    background: apiStatus.notion ? "#4ade80" : "#f87171", 
                    width: "6px", height: "6px", borderRadius: "50%", display: "inline-block"
                  }}></span>
                  <span style={{ color: "rgba(255,255,255,0.5)", fontSize: "10px" }}>DB</span>
                </div>
                <div style={{ display: "flex", alignItems: "center", gap: "5px" }}>
                  <span style={{ 
                    background: apiStatus.anthropic ? "#4ade80" : "#f87171", 
                    width: "6px", height: "6px", borderRadius: "50%", display: "inline-block"
                  }}></span>
                  <span style={{ color: "rgba(255,255,255,0.5)", fontSize: "10px" }}>Claude</span>
                </div>
                <div style={{ display: "flex", alignItems: "center", gap: "5px" }}>
                  <span style={{ 
                    background: apiStatus.cloudinary ? "#4ade80" : "#f87171", 
                    width: "6px", height: "6px", borderRadius: "50%", display: "inline-block"
                  }}></span>
                  <span style={{ color: "rgba(255,255,255,0.5)", fontSize: "10px" }}>Cloudinary</span>
                </div>
              </div>
            </div>
          </footer>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<SchweissGutachterApp />);
  </script>
</body>
</html>
